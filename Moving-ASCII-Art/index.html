<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Live ASCII Viewer</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            background: #111;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>

<body>
    <canvas id="c"></canvas>

    <script>
        const canvas = document.getElementById("c");
        const ctx = canvas.getContext("2d", { alpha: false });

        const PAD = 12;

        const BG_COLOR = "#111111";
        const TEXT_COLOR = "#666666";

        const FONT_PX = 14;
        const LINE_H = 16;

        const FRAME_MS = 33;

        let dpr = 1;
        let CHAR_W = 8;
        let maxCols = 1;
        let maxLines = 1;

        function resize() {
            const cssW = window.innerWidth;
            const cssH = window.innerHeight;

            dpr = window.devicePixelRatio || 1;

            canvas.style.width = cssW + "px";
            canvas.style.height = cssH + "px";
            canvas.width = Math.round(cssW * dpr);
            canvas.height = Math.round(cssH * dpr);

            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            ctx.font = `${FONT_PX}px Consolas, "Cascadia Mono", Menlo, Monaco, monospace`;
            ctx.textBaseline = "top";

            CHAR_W = Math.max(1, Math.ceil(ctx.measureText("M").width));
            maxCols = Math.max(1, Math.floor((cssW - PAD * 2) / CHAR_W));
            maxLines = Math.max(1, Math.floor((cssH - PAD * 2) / LINE_H));
        }

        window.addEventListener("resize", resize);
        resize();

        let lastText = "";

        async function fetchAscii() {
            const res = await fetch("ascii.txt?ts=" + Date.now(), { cache: "no-store" });
            if (!res.ok) return null;
            return await res.text();
        }

        function draw(text) {
            const w = canvas.width / dpr;
            const h = canvas.height / dpr;

            ctx.fillStyle = BG_COLOR;
            ctx.fillRect(0, 0, w, h);

            ctx.fillStyle = TEXT_COLOR;

            let y = PAD;
            let start = 0;
            let line = 0;

            for (let i = 0; i <= text.length && line < maxLines; i++) {
                if (i === text.length || text.charCodeAt(i) === 10) {
                    let s = text.slice(start, i);
                    if (s.length > maxCols) s = s.slice(0, maxCols);
                    ctx.fillText(s, PAD, y);
                    y += LINE_H;
                    line++;
                    start = i + 1;
                }
            }
        }

        async function loop() {
            const start = performance.now();

            try {
                const text = await fetchAscii();
                if (text !== null && text !== lastText) {
                    lastText = text;
                    requestAnimationFrame(() => draw(text));
                }
            } catch (_) { }

            const elapsed = performance.now() - start;
            setTimeout(loop, Math.max(0, FRAME_MS - elapsed));
        }

        loop();
    </script>
</body>

</html>
